
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ansible and resolving hostnames - sap1ens blog</title>
  <meta name="author" content="Yaroslav Tkachenko">

  
  <meta name="description" content="Recently I’ve worked on a very simple Ansible task. My goal was to start an environment, wait until it becomes available (online) and do some things &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sap1ens.com/blog/2015/02/09/ansible-and-resolving-hostnames">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="sap1ens blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-21545352-9']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
</header>
  <div class="social-networks">
    <ul>
      <li><a href="https://github.com/sap1ens" class="symbol" title="githubalt" target="_blank"></a></li>
      <li><a href="http://ca.linkedin.com/in/sap1ens" class="symbol" title="linkedin" target="_blank"></a></li>
      <li><a href="https://twitter.com/sap1ens" class="symbol" title="twitter" target="_blank"></a></li>
      <li><a href="https://www.facebook.com/yaroslav.tkachenko" class="symbol" title="facebook" target="_blank"></a></li>
      <li><a href="http://stackoverflow.com/users/899937/sap1ens" class="symbol" title="stackoverflow" target="_blank"></a></li>
    </ul>
  </div>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="sap1ens.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/talks">Talks</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
  
    
      <h1 class="entry-title">Ansible and Resolving Hostnames</h1>
    
  
    
      <p class="meta">
        








  


<time datetime="2015-02-09T20:13:50-08:00" pubdate data-updated="true">Feb 9<span>th</span>, 2015</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Recently I’ve worked on a very simple Ansible task. My goal was to start an environment, wait until it becomes available (online) and do some things after. With environment I mean a web service &ndash; imagine any language or framework you want. Let’s say you need to access some specific URL like /api/heartbeat to make sure it’s initialized properly.</p>

<p>Piece of cake, right?</p>

<!-- more -->


<h2>Attempt #1</h2>

<p>If you take a look at the list of all Ansible modules <a href="http://docs.ansible.com/list_of_all_modules.html">here</a>, first of all you probably notice <strong>wait_for</strong>. Let’s try to use it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">--- </span>
</span><span class='line'><span class="l-Scalar-Plain"> - hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'><span class="l-Scalar-Plain">   tasks</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">     - wait_for</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">host=http://domain.com/api/heartbeat port=80 timeout=5</span>
</span></code></pre></td></tr></table></div></figure>


<p>(I’m using small timeout here just for demo purposes.)</p>

<p>Result: <em>msg: Timeout when waiting for …</em></p>

<p>So, <strong>wait_for</strong> doesn’t actually work in our case &ndash; it accepts only hostnames without additional path. Ok, skip it.</p>

<p>How about <strong>uri</strong> module? Looks promising:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">--- </span>
</span><span class='line'><span class="l-Scalar-Plain"> - hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'><span class="l-Scalar-Plain">   tasks</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">     - uri</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">url=http://domain.com/api/heartbeat timeout=5</span>
</span></code></pre></td></tr></table></div></figure>


<p>It should work, but I have a very specific use case &ndash; every environment I start can also create a new CNAME address. It requires some time to become resolvable. So, unfortunately result is <em>msg: Unable to resolve the host name given.</em></p>

<p>I’ve realized that I couldn’t do it with Ansible tools.</p>

<h2>Attempt #2</h2>

<p>If Ansible is powerless let’s just use old school bash. How about that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">--- </span>
</span><span class='line'><span class="l-Scalar-Plain"> - hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'><span class="l-Scalar-Plain">   tasks</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">     - shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">curl --silent --show-error --output /dev/null --retry 90 --retry-delay 10 --retry-max-time 900 http://domain.com/api/heartbeat</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looks like it works! Except it doesn’t :&ndash;/</p>

<p>If you run this playbook you see that it actually waits for the URL to be available. But there is a problem in the interval between environment becoming resolvable and environment returning HTTP reply. Curl fails in that specific moment.</p>

<p>Wget is better in this case, it has <em>retry-connrefused</em> flag that really helps with the issue. Unfortunately it fails with the part of resolving hostname.</p>

<h2>Attempt #3</h2>

<p>I’ve decided to continue with Curl approach, but improve it as much as I can. So, finally:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">--- </span>
</span><span class='line'><span class="l-Scalar-Plain"> - hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'><span class="l-Scalar-Plain">   tasks</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">     - script</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">scripts/wait_for.sh http://domain.com/api/heartbeat</span>
</span></code></pre></td></tr></table></div></figure>


<p>where wait_for.sh:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh </span>
</span><span class='line'> until curl --silent --output /dev/null <span class="nv">$1</span>; <span class="k">do</span>
</span><span class='line'>   <span class="nb">echo </span>Could not fetch, retrying...
</span><span class='line'>   sleep 30
</span><span class='line'> done
</span></code></pre></td></tr></table></div></figure>


<p>Looks really optimistic (and simple!), but you can always cancel it.</p>

<h2>Conclusion</h2>

<p>I really like the Ansible way, because you can always switch to old school bash and implement whatever you want. I’ve almost decided that this task is impossible to do with Ansible but finally did it in a different way. Don’t be afraid and experiment!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Yaroslav Tkachenko</span></span>

      








  


<time datetime="2015-02-09T20:13:50-08:00" pubdate data-updated="true">Feb 9<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/ansible/'>Ansible</a>, <a class='category' href='/blog/categories/devops/'>DevOps</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://sap1ens.com/blog/2015/02/09/ansible-and-resolving-hostnames/" data-via="sap1ens" data-counturl="http://sap1ens.com/blog/2015/02/09/ansible-and-resolving-hostnames/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/12/06/state-1-slash-scale/" title="Previous Post: State &#8733; 1 / Scale">&laquo; State &#8733; 1 / Scale</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/05/31/polyglotconf-quotes/" title="Next Post: Polyglotconf quotes">Polyglotconf quotes &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/07/10/syrup-scrum-cli-tool/">Syrup - Scrum CLI tool</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/19/postgres-jsonb-indexing-is-tricky/">Postgres JSONB indexing is tricky</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/28/polyglotconf-2016-talk/">Polyglotconf 2016 Talk</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/22/static-typing-and-refactoring/">Static typing and refactoring</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/25/about-technical-leadership/">About technical leadership</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/sap1ens">@sap1ens</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sap1ens',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/YaroslavTkachenko?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - 2016 | Yaroslav Tkachenko <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, customized with <a href="https://github.com/mjhea0/whiterspace">whiterspace</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sap1ens';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://sap1ens.com/blog/2015/02/09/ansible-and-resolving-hostnames/';
        var disqus_url = 'http://sap1ens.com/blog/2015/02/09/ansible-and-resolving-hostnames/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
