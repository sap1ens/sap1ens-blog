
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Postgres JSONB indexing is tricky - sap1ens blog</title>
  <meta name="author" content="Yaroslav Tkachenko">

  
  <meta name="description" content="I’m not a Postgres expert, but I’ve been using it for about 6 months as an Event Store database. At Bench we’ve built our own eventing system on top &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://sap1ens.com/blog/2016/06/19/postgres-jsonb-indexing-is-tricky">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="sap1ens blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-21545352-9']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
</header>
  <div class="social-networks">
    <ul>
      <li><a href="https://github.com/sap1ens" class="symbol" title="githubalt" target="_blank"></a></li>
      <li><a href="http://ca.linkedin.com/in/sap1ens" class="symbol" title="linkedin" target="_blank"></a></li>
      <li><a href="https://twitter.com/sap1ens" class="symbol" title="twitter" target="_blank"></a></li>
      <li><a href="https://www.facebook.com/yaroslav.tkachenko" class="symbol" title="facebook" target="_blank"></a></li>
      <li><a href="http://stackoverflow.com/users/899937/sap1ens" class="symbol" title="stackoverflow" target="_blank"></a></li>
    </ul>
  </div>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="sap1ens.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/talks">Talks</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
  
    
      <h1 class="entry-title">Postgres JSONB Indexing Is Tricky</h1>
    
  
    
      <p class="meta">
        








  


<time datetime="2016-06-19T18:39:15-07:00" pubdate data-updated="true">Jun 19<span>th</span>, 2016</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>I’m not a Postgres expert, but I’ve been using it for about 6 months as an Event Store database. At Bench we’ve built our own eventing system on top of ActiveMQ, Camel and Akka and we use Postgres to persist every single Domain Event.</p>

<p>Our event schema is very flexible and currently represented in JSON. We chose Postgres for persistence, because of the great JSON support. As you probably know, Postgres 9.4 introduced JSONB type, which is an advanced JSON type that supports indexing. Obviously, you should index all your key fields, but it can be tricky. Let me share what we’ve discovered.</p>

<!-- more -->


<h2>Problem</h2>

<p>So, we have a query like this:</p>

<blockquote><p>select &ldquo;id&rdquo;, &ldquo;created_at&rdquo;, &ldquo;version&rdquo;, &ldquo;name&rdquo;, &ldquo;context&rdquo;, &ldquo;assets&rdquo; from &ldquo;event&rdquo; where (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;569ee61ee4b0e7dd960dcee3&rdquo;}]&rsquo;) or (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;874874&rdquo;}]&rsquo; ) or (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;875187&rdquo;}]&rsquo; ) or (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;858164&rdquo;}]&rsquo; ) or (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;858567&rdquo;}]&rsquo;) order by &ldquo;created_at&rdquo; desc limit 1000 offset 0</p></blockquote>

<p><code>assets</code> field is a JSON array that contains different entities (objects). Some of them have <code>resourceId</code> field. In this query we want to find all events that contain assets with specified <code>resourceId</code>s. We only pass 5 <code>resourceId</code>s here, but in practice we can have many more.</p>

<p>Of course we have an index on this field:</p>

<blockquote><p>CREATE INDEX event_idx_assets ON event USING gin (assets jsonb_path_ops)</p></blockquote>

<p>But… when you run the query, it can be REALLY slow. Let’s run <code>analyze</code>:</p>

<blockquote><p>explain analyze select &ldquo;id&rdquo;, &ldquo;created_at&rdquo;, &ldquo;version&rdquo;, &ldquo;name&rdquo;, &ldquo;context&rdquo;, &ldquo;assets&rdquo; from &ldquo;event&rdquo; where (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;569ee61ee4b0e7dd960dcee3&rdquo;}]&rsquo;) or (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;874874&rdquo;}]&rsquo; ) or (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;875187&rdquo;}]&rsquo; ) or (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;858164&rdquo;}]&rsquo; ) or (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;858567&rdquo;}]&rsquo;) order by &ldquo;created_at&rdquo; desc limit 1000 offset 0</p></blockquote>

<p>Results:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Limit  (cost=0.43..19176.24 rows=1000 width=322) (actual time=46.737..2730.530 rows=8 loops=1)
</span><span class='line'> -&gt;  Index Scan Backward using event_idx_created_at on event  (cost=0.43..142898.56 rows=7452 width=322) (actual time=46.733..2730.505 rows=8 loops=1)
</span><span class='line'>       Filter: ((assets @&gt; '[{"resourceId": "569ee61ee4b0e7dd960dcee3"}]'::jsonb) OR (assets @&gt; '[{"resourceId": "874874"}]'::jsonb) OR (assets @&gt; '[{"resourceId": "875187"}]'::jsonb) OR (assets @&gt; '[{"resourceId": "858164"}]'::jsonb) OR (assets @&gt; '[{"resourceId": "858567"}]'::jsonb))
</span><span class='line'>       Rows Removed by Filter: 1485296
</span><span class='line'>Planning time: 0.134 ms
</span><span class='line'>Execution time: 2730.569 ms</span></code></pre></td></tr></table></div></figure>


<p>Wait… It doesn’t use our index! And it’s very slow because of that. But why? If you read documentation and StackOverflow discussions about indexing, you’ll see that it should work. There is no reason why it shouldn’t…</p>

<p>We’ve spent significant amount of time trying to understand why this index doesn’t work. After some we did an experiment &ndash; what if you run the query with only one <code>resourceId</code>?</p>

<blockquote><p>explain analyze select &ldquo;id&rdquo;, &ldquo;created_at&rdquo;, &ldquo;version&rdquo;, &ldquo;name&rdquo;, &ldquo;context&rdquo;, &ldquo;assets&rdquo; from &ldquo;event&rdquo; where (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;569ee61ee4b0e7dd960dcee3&rdquo;}]&rsquo;) order by &ldquo;created_at&rdquo; desc limit 1000 offset 0</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Limit  (cost=6725.17..6727.67 rows=1000 width=322) (actual time=3.732..3.735 rows=1 loops=1)
</span><span class='line'> -&gt;  Sort  (cost=6725.17..6728.91 rows=1493 width=322) (actual time=3.728..3.729 rows=1 loops=1)
</span><span class='line'>       Sort Key: created_at
</span><span class='line'>       Sort Method: quicksort  Memory: 25kB
</span><span class='line'>       -&gt;  Bitmap Heap Scan on event  (cost=1315.57..6646.46 rows=1493 width=322) (actual time=3.716..3.718 rows=1 loops=1)
</span><span class='line'>             Recheck Cond: (assets @&gt; '[{"resourceId": "569ee61ee4b0e7dd960dcee3"}]'::jsonb)
</span><span class='line'>             Heap Blocks: exact=1
</span><span class='line'>             -&gt;  Bitmap Index Scan on event_idx_assets  (cost=0.00..1315.20 rows=1493 width=0) (actual time=3.700..3.700 rows=1 loops=1)
</span><span class='line'>                   Index Cond: (assets @&gt; '[{"resourceId": "569ee61ee4b0e7dd960dcee3"}]'::jsonb)
</span><span class='line'>Planning time: 0.116 ms
</span><span class='line'>Execution time: 3.771 ms</span></code></pre></td></tr></table></div></figure>


<p>It works! How about 3?</p>

<blockquote><p>explain analyze select &ldquo;id&rdquo;, &ldquo;created_at&rdquo;, &ldquo;version&rdquo;, &ldquo;name&rdquo;, &ldquo;context&rdquo;, &ldquo;assets&rdquo; from &ldquo;event&rdquo; where (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;569ee61ee4b0e7dd960dcee3&rdquo;}]&rsquo;) or (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;874874&rdquo;}]&rsquo; ) or (&ldquo;assets&rdquo; @> &lsquo;[{&ldquo;resourceId&rdquo;: &ldquo;875187&rdquo;}]&rsquo; ) order by &ldquo;created_at&rdquo; desc limit 1000 offset 0</p></blockquote>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Limit  (cost=18630.81..18633.31 rows=1000 width=322) (actual time=10.453..10.462 rows=3 loops=1)
</span><span class='line'> -&gt;  Sort  (cost=18630.81..18642.00 rows=4476 width=322) (actual time=10.450..10.453 rows=3 loops=1)
</span><span class='line'>       Sort Key: created_at
</span><span class='line'>       Sort Method: quicksort  Memory: 26kB
</span><span class='line'>       -&gt;  Bitmap Heap Scan on event  (cost=3948.96..18385.39 rows=4476 width=322) (actual time=10.430..10.439 rows=3 loops=1)
</span><span class='line'>             Recheck Cond: ((assets @&gt; '[{"resourceId": "569ee61ee4b0e7dd960dcee3"}]'::jsonb) OR (assets @&gt; '[{"resourceId": "874874"}]'::jsonb) OR (assets @&gt; '[{"resourceId": "875187"}]'::jsonb))
</span><span class='line'>             Heap Blocks: exact=1
</span><span class='line'>             -&gt;  BitmapOr  (cost=3948.96..3948.96 rows=4480 width=0) (actual time=10.416..10.416 rows=0 loops=1)
</span><span class='line'>                   -&gt;  Bitmap Index Scan on event_idx_assets  (cost=0.00..1315.20 rows=1493 width=0) (actual time=3.708..3.708 rows=1 loops=1)
</span><span class='line'>                         Index Cond: (assets @&gt; '[{"resourceId": "569ee61ee4b0e7dd960dcee3"}]'::jsonb)
</span><span class='line'>                   -&gt;  Bitmap Index Scan on event_idx_assets  (cost=0.00..1315.20 rows=1493 width=0) (actual time=3.354..3.354 rows=1 loops=1)
</span><span class='line'>                         Index Cond: (assets @&gt; '[{"resourceId": "874874"}]'::jsonb)
</span><span class='line'>                   -&gt;  Bitmap Index Scan on event_idx_assets  (cost=0.00..1315.20 rows=1493 width=0) (actual time=3.349..3.349 rows=1 loops=1)
</span><span class='line'>                         Index Cond: (assets @&gt; '[{"resourceId": "875187"}]'::jsonb)
</span><span class='line'>Planning time: 0.120 ms
</span><span class='line'>Execution time: 10.525 ms</span></code></pre></td></tr></table></div></figure>


<p>Success! It seems like somewhere internally Postgres decides to optimize this query differently depending on the number of conditions you pass for the GIN indexed field. In our case index only worked with 1, 2 and 3 conditions.</p>

<h2>Solution</h2>

<p>Well, you can’t really fix the indexing, but at least you know how to use it :) We ended up chunking one big query with lots of conditions into multiple queries containing only 3 conditions and merging results together. Unexpectedly, it’s <em>much</em> faster!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Yaroslav Tkachenko</span></span>

      








  


<time datetime="2016-06-19T18:39:15-07:00" pubdate data-updated="true">Jun 19<span>th</span>, 2016</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/postgres/'>Postgres</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://sap1ens.com/blog/2016/06/19/postgres-jsonb-indexing-is-tricky/" data-via="sap1ens" data-counturl="http://sap1ens.com/blog/2016/06/19/postgres-jsonb-indexing-is-tricky/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/05/28/polyglotconf-2016-talk/" title="Previous Post: Polyglotconf 2016 Talk">&laquo; Polyglotconf 2016 Talk</a>
      
      
        <a class="basic-alignment right" href="/blog/2016/07/10/syrup-scrum-cli-tool/" title="Next Post: Syrup - Scrum CLI tool">Syrup - Scrum CLI tool &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/07/10/syrup-scrum-cli-tool/">Syrup - Scrum CLI tool</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/19/postgres-jsonb-indexing-is-tricky/">Postgres JSONB indexing is tricky</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/28/polyglotconf-2016-talk/">Polyglotconf 2016 Talk</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/22/static-typing-and-refactoring/">Static typing and refactoring</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/25/about-technical-leadership/">About technical leadership</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/sap1ens">@sap1ens</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'sap1ens',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/YaroslavTkachenko?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - 2016 | Yaroslav Tkachenko <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, customized with <a href="https://github.com/mjhea0/whiterspace">whiterspace</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sap1ens';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://sap1ens.com/blog/2016/06/19/postgres-jsonb-indexing-is-tricky/';
        var disqus_url = 'http://sap1ens.com/blog/2016/06/19/postgres-jsonb-indexing-is-tricky/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
